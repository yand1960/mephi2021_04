<html>
    <head>
        <meta charset="utf-8">
        <style>
            html {
				
				background-image: url(../images/basket.jpg);
			}
            #buy_button {
                margin-bottom: 20px;
                background: transparent;
                
            }

        </style>

        <script>
            function getTotal(carts) {
                document.getElementById("buy_button").hidden = false;
                total_qty = 0;
                total_price = 0;
                for([id, value] of Object.entries(carts)) {
                    total_qty += Number(value.quantity);
                    total_price += Number(value.quantity) * Number(value.price);
                }
                if (total_qty == 0){
                    text = `Ваша корзина пуста`;
                    document.getElementById("buy_button").hidden = true;
                }
                else{
                    text =`Товаров в корзине: ${total_qty} шт. на сумму ${total_price} ₽`;
                    document.getElementById("buy_button").hidden = false;
                }
                document.getElementById("storage").innerHTML = text

            }

            async function getCarts() {
                var url = "get_from_cart.php";
                var request = await fetch(url);
                var carts = await request.json();
                console.log(carts);
                out = "<table>"
                for([id, value] of Object.entries(carts)) {
                    if (Number(value.quantity) != 0){
                        out += `
                            <tr>
                                <td id="id_${id}">${value.name}</td>
                                <td><input type = "number" value="${value.quantity}" id='qty_${id}'></td>
                                <td><button onclick='addToCart(${id})'>Добавить</button></td>
                                <td><button onclick='removeFromCart(${id})'>Удалить товар</button></td>
                            </tr>
                        `;
                    }
                }
                out += "</table>"
                    document.getElementById("display").innerHTML = out;

                    getTotal(carts);
            }

            async function cartDeals(id, qty){
                var url = `add_product_to_cart.php?id=${id}&qty=${qty}`;
                console.log(url);
                var request = await fetch(url);
                var result = await request.json();
            }

            async function removeFromCart(id){
                var qty = 0
                await cartDeals(id, qty);
                await getCarts();

            }


            async function addToCart(id) {
                var qty = document.getElementById(`qty_${id}`).value;
                await cartDeals(id, qty);
                await getCarts();
            }

            async function buy(){
                var url = `buy.php`;
                var response = await fetch(url);
                var result = await response.json();
                console.log(result);
                await getCarts();
                document.getElementById("bags").innerHTML = `Спасибо за покупку!`;
                document.getElementById("storage").innerHTML = `Вы будете перенаправлены на главную странцу через 5 секунд`;
                setTimeout(function(){
                window.location = '../shop.html';
                }, 5000);
                    
            }
        
            
        </script>
    </head>


    <body onload="getCarts();">
        <h1 id="bags">Ваши покупки!</h1>
        <div id="display">
        </div>
        <h3 id="storage"></h3>
        <button id="buy_button" onclick='buy()'>Купить</button></br>
        <a href="../shop.html">Перейти в каталог товаров</a>
    </body>
</html>